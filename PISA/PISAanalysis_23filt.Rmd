---
title: "PISA"
author: "Linn√©a Strandberg, Jan Karlsen"
date: "7/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PISA data processing

Manually adjust required parameters under '# Setting variables manually' prior running.

Run .rs.restartR() prior code, certain parts might be unintentionally masked if codes with other libraries than tidyverse has been read before.

Script to normalize and perform statistical analysis on differently treated protein samples with the possibility to remove outliers. The script generates lists of detected proteins, processed normalized data, statistical analysis and ECDF, PCA and volcano plots. Outliers prior normalization are checked on cumulative peptide intensities from EncyclopeDIA. Intensities are normalized over samples on protein intensities calculated in EncyclopeDIA. Group comparison is performed on normalized protein intensities. Proteins have to be detected in n-1 samples in order to be included in the analysis, where n is the number of replicates after the possible removal of outliers.


```{r, message = FALSE}
library(tidyverse)
library(MSstats)
library(ggfortify)
library(gridExtra)
library(ggrepel)
library(ggplot2)
```

# Setting variables manually

'run' = date of the MS run
'organism' = "synechocystis", "arabidopsis" etc.
'searchmode' = name of the file used as library in EncyclopeDIA, such as "pcc6803"
These variables constitute the name of the quant report (data generated by EncyclopeDIA), for example quant_report_synechocystis_pcc6803_20220607, and will also be used to name the output files

'remove_samp' = replicates that should be removed, written as a vector and named metabolite_treatment_replicate, for example c("ATP_0_1", "ATP_3_1")
'FC' = fold change threshold to be accounted as significant
'qval' = q-value threshold to be accounted as significant

```{r}
run <- "20220606"
organism <- "synechocystis"
searchmode <- "pcc6803"

remove_samp <- c()
FC <- 2
qval <- 0.01
```

# Read input files

'platelayout' has the columns "Well" = autosampler position + well (ex. "RA1", "RA2" etc.) and "Name" = metabolite_condition_replicate (ex. "ATP_B_1", "ATP_B_2" etc.)
'prot' is a .elib.proteins.txt from EncyclopeDIA
'pep' is a .elib.peptides.txt from EncyclopeDIA
'protein_properties' is a .csv from UniProt with protein properties

```{r, message = FALSE}
platelayout <- read_csv(file = paste("data/", organism, "/plate_layouts/plate_layout_", organism, "_", run, ".csv", sep = ""))
prot <- read_tsv(paste("data/", organism, "/quant_reports/quant_report_", organism, "_",
                      searchmode, "_", run, ".elib.proteins.txt", sep = ""))
pep <- read_tsv(paste("data/", organism, "/quant_reports/quant_report_", organism, "_",
                      searchmode, "_", run, ".elib.peptides.txt", sep = ""))
protein_properties <- read_csv2(paste("libraries/", organism, "/uniprot/", organism, ".csv", sep = "")) %>%
  select('Entry', 'Gene names  (primary )', 'Protein names')
```

# Check for outliers

Peptide distributions are compared using estimator of the Cumulative Distribution Function. Peptides with a differently shaped curve are not suitable for median normalization. Curves having the same shape but shifted in x-direction are accepted.

```{r, warning = FALSE}
pep <- pep %>%
  gather(key = "Sample", value = "Intensity", 4:(ncol(prot))) %>%
  mutate(Sample = (str_sub(Sample, 50, nchar(Sample)-5))) %>%
  left_join(platelayout, by = c("Sample" = "Well")) %>%
  separate(col = Name, into = c("Treatm", "Conc", "TechReplicate"), sep = "_", remove = F) %>%
  unite("Condition", Treatm:Conc, sep = "_", remove = F)

g <- ggplot(pep, aes(log(Intensity), colour = Name)) +
      stat_ecdf(geom = "step") +
      xlab("log2(Peptide intensity)") +
      theme_bw()

plot(g)

rm(pep)

ggsave(filename = paste("output/", organism, "/plots/ecdf/ecdf_", organism, "_", searchmode, "_",
                         run, ".png", sep = ""),
        plot = g, units = "mm", width = 200, height = 80, dpi = 300)
```
# Prepare the protein list 

Annotate proteins that have ambiguous entries. Annotate data with treatment, concentration and technical replicate.

```{r}
prot$Ambig <- ifelse(grepl(";", prot$Protein), "Yes", "No")

prot <- prot %>% 
  separate_rows(Protein, sep = ";") %>%  
  separate(col = Protein,into = c("db", "Entry", "Entry_name"), sep = "\\|", remove = F) 

prot <- prot %>%
  gather(key = "Sample", value = "Intensity", 7:(ncol(prot)-1)) %>%
  mutate(Sample = (str_sub(Sample, 50, nchar(Sample)-5))) %>%
  left_join(platelayout, by = c("Sample" = "Well")) %>%
  separate(col = Name, into = c("Treatm", "Conc", "TechReplicate"), sep = "_", remove = F) %>%
  unite("Condition", Treatm:Conc, sep = "_", remove = F)
```

# Annotate proteins

Create lists of detected proteins with UniProt annotations.

```{r}
annot <- left_join(select(prot, Protein, Entry, Ambig, PeptideSequences),
                   protein_properties, by = "Entry")

rm(protein_properties)

write_csv(annot, paste("output/", organism, "/detected_proteins/detected_proteins", searchmode, "_", run, ".csv", sep = ""))

amb_annot <- filter(annot, Ambig == "Yes")
write_csv(amb_annot, paste("output/", organism, "/detected_proteins/detected_ambiguous_proteins", searchmode, "_", run, ".csv", sep = ""))
```

# Filter proteins

Keep one protein if several have matching peptide combinations, since MSstats cannot handle duplicates. The one removed are added after the statistical analysis. Remove desired replicates. Filter proteins that have intensity 0 and are missing in more than one replicate after outliers have been removed. 

```{r}
prot <- prot %>%
  group_by(Name, Treatm) %>%
  filter(!duplicated(PeptideSequences)|n()==1)

prot <- prot %>%
  filter(!Name %in% remove_samp)

prot <- prot %>% group_by(Condition, Protein) %>%
  mutate(Num = sum(Intensity>0)) %>%
  group_by(Condition) %>%
  filter(Num >= (max(Num)-1)) %>% 
  select(-Num)

prot <- prot %>% 
  group_by(Treatm) %>%
  mutate(Num = length(unique(Name))) %>%
  group_by(Protein, Treatm) %>%
  filter(n() == Num) %>% 
  select(-Num)
```

# Prepare the files for MSstats normalization in the correct format.

```{r, message = FALSE}
prot <- prot %>% dplyr::rename(ProteinName = Entry, PeptideSequence = PeptideSequences, Run = Name) %>%
  mutate(PrecursorCharge = 0, FragmentIon = 0, ProductCharge = 0, IsotopeLabelType = "L", BioReplicate = 1) %>%
  select(ProteinName, PeptideSequence, PrecursorCharge,
         FragmentIon, ProductCharge, IsotopeLabelType, Condition, BioReplicate, Run,
         Intensity, Treatm)

prot <- prot %>% group_by(Treatm) %>% group_split()
```

# Normalization

Median normalization, using the formula:
log2(Intensity) - log2(median(sample intensities)) + log2(median(median(all sample intensities)))

```{r}

quant_list <- lapply(prot, function(tbl) {
  Quant <- dataProcess(
    tbl,
    logTrans = 2,
    normalization = "equalizeMedians",
    censoredInt = "0",
    use_log_file = FALSE)
})

# Save Processed Data       
saveRDS(quant_list, file = paste("output/", organism, "/normalized_data/procdata_", 
                                 organism, "_", searchmode, "_", run, ".RData", sep = ""))
```

# Statistical analysis

Group comparison. Generate files with statistical components, including fold change, p-value and adjusted p-values. Ambiguous proteins previously filtered are added so that all possible peptide - protein combinations are included.

```{r}
stats <- function(x) {
  
  experiment <- substr(levels(x$FeatureLevelData$GROUP[1])[1], 1, nchar(levels(x$FeatureLevelData$GROUP[1])[1]) -2)

  nbr_comp <- length(unique(x$FeatureLevelData$GROUP)) - 1
  comparison_mtx <- cbind(matrix(rep(-1, nbr_comp)),
                          diag(nbr_comp))
  
  rownames(comparison_mtx) <- levels(x$FeatureLevelData$GROUP)[2:(nbr_comp+1)]
  
  groups <- levels(x$ProteinLevelData$GROUP)
  
  colnames(comparison_mtx) <- groups[order(as.numeric(groups))]
  
  groupComp_result <- groupComparison(contrast.matrix = comparison_mtx,
                                      data = x,
                                      use_log_file = FALSE)
  
  comparisonResult <- groupComp_result$ComparisonResult
  modelQC <- groupComp_result$ModelQC
  
  # Remove comparisons which have zero observations in any condition
  removed_comp <- comparisonResult %>% filter(!is.na(issue))
  comparisonResult <- filter(comparisonResult, is.na(issue))
  
  #Add all proteins (including the ambiguous alternatives that were removed earlier)
  stat_annot <- unique(annot) %>%
    select(Entry, PeptideSequences, `Gene names  (primary )`, Ambig) %>%
    right_join(comparisonResult, by = c("Entry" = "Protein"))
  
  stat_annot_amb <- unique(amb_annot) %>%
    select(Entry, PeptideSequences, `Gene names  (primary )`, Ambig) %>%
    left_join(stat_annot, by = "PeptideSequences") %>%
    dplyr::rename(Entry = Entry.x, `Gene names  (primary )` = `Gene names  (primary ).x`,
                  Ambig = Ambig.x) %>%
    select(-Entry.y, -`Gene names  (primary ).y`, -Ambig.y)
    
  stat <- full_join(stat_annot, stat_annot_amb) %>%
    select(-PeptideSequences)
  
    write_csv(stat,
            paste("output/", organism, "/comparisonresult/comparisonresult_", searchmode, "_", experiment, "_grouped_", run,
                  ".csv", sep = ""))
  write_csv(modelQC,
            paste("output/", organism, "/modelqc/modelqc_", searchmode, "_", experiment, "_grouped_", run,
                  ".csv", sep = ""))
  
  return(stat)
  
}

statistics <- lapply(quant_list, stats)

```

# PCA plots

Check for outlier replicates. Consider removing these from the data.

```{r}
pca <- function(x) {
  
  
  proc_wide <- x$FeatureLevelData %>% select(PROTEIN, originalRUN, INTENSITY) %>%
    arrange(originalRUN) %>% pivot_wider(names_from = originalRUN, values_from = INTENSITY)
    pca_matrix <- proc_wide %>% column_to_rownames("PROTEIN") %>% t %>% as.data.frame
  pca_matrix$Treatment <- substr(row.names(pca_matrix), str_count(row.names(pca_matrix))-2, str_count(row.names(pca_matrix))-2)
    pca_matrix$Sample <- substr(row.names(pca_matrix), str_count(row.names(pca_matrix))-2, str_count(row.names(pca_matrix)))
  pca_matrix$Metabolite <- substr(row.names(pca_matrix), 1, str_count(row.names(pca_matrix))-4)
  pca <- prcomp(select(pca_matrix, -c(Treatment, Sample, Metabolite)), center = T, scale = F)

    g <- autoplot(pca, data = pca_matrix, colour = 'Treatment', frame = TRUE, 
                  frame.type = 'norm') +
      geom_text(vjust=-1, label=pca_matrix$Sample, size = 3) +
      ggtitle(pca_matrix$Metabolite) +
      theme_bw()
    
      ggsave(filename = paste("output/", organism, "/plots/pca/pca_new", "_", searchmode, "_", pca_matrix$Metabolite[1], "_", run, ".png", sep = ""), plot = g, units = "mm", width = 200,
             height = 200, dpi = 300)
      
    return(g)
}

pca_plots <- lapply(quant_list, pca)
grid.arrange(grobs = pca_plots, nrow = length(pca_plots))

```

# Volcano plots

Statistically significant proteins are annotated and highlighted in red.

```{r, warning = FALSE}
volc <- function(p) {
  
  experiment <- substr(p$Label[[1]], 1, str_count(p$Label[[1]])-2)
  
  p$sign <- ifelse(p$adj.pvalue <= qval & p$log2FC > log2(FC) | p$adj.pvalue <=  qval & p$log2FC < -log2(FC), "Significant", "Unsignifiant")
  p$label <- ifelse(p$sign == "Significant", p$`Gene names  (primary )`, "")
  
  g <- ggplot(data = p, aes(y = -log10(adj.pvalue), x = log2FC, color = sign, label = label)) +
    geom_point(size = 1, alpha = 0.5) +
    geom_text_repel(show_guide  = FALSE, size = 2) +
    geom_vline(xintercept = c(-log2(FC), log2(FC)),
                 linetype="dashed", size = 0.2 , alpha = 0.5) +
    geom_hline(yintercept = -log10(qval),
                 linetype="dashed", size = 0.2 , alpha = 0.5) +      
    scale_color_manual(values = c("red", "gray50"), limits = c("Significant", "Unsignifiant"), name = "") +
    labs(title = experiment, x = "log2(FC)", y = "-log(q-value)") +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
    ggsave(filename = paste("output/", organism, "/plots/volcano_plots/volcano_", experiment, "_q",
                            qval, "_fc", FC, "_", searchmode, "_", run, ".png", sep = ""),
           plot = g, units = "mm", width = 120, height = 200, dpi = 300)
    
    return(g)
}

volcano_plots <- lapply(statistics, volc)
grid.arrange(grobs = volcano_plots, nrow = length(volcano_plots))

```


```{r}
sessionInfo()
```